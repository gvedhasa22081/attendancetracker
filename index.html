<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMART FACE ATTENDANCE SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
    }

    h1 {
        margin-top: 25px;
        color: #4ade80;
        font-size: 32px;
    }

    #cameraBox {
        width: 70%;
        height: 350px;
        border: 3px solid #4ade80;
        border-radius: 15px;
        margin: 25px auto;
        position: relative;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 15px;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
    }

    #message {
        margin-top: 20px;
        padding: 12px;
        border-radius: 10px;
        width: 60%;
        margin-left: auto;
        margin-right: auto;
        display: none;
        font-size: 18px;
    }

    .success { background: #14532d; border: 1px solid #4ade80; }
    .error   { background: #450a0a; border: 1px solid #ef4444; }

    .container {
        margin-top: 40px;
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
    }

    .box {
        background: #1e293b;
        width: 40%;
        min-width: 280px;
        padding: 25px;
        border-radius: 12px;
    }

    .present { font-size: 22px; color: #4ade80; margin-bottom: 10px; }
    .pending { font-size: 22px; color: #facc15; margin-bottom: 10px; }

    ul { list-style: none; padding: 0; font-size: 18px; text-align: left; }
    li { margin: 5px 0; }

</style>
</head>

<body>

<h1>SMART FACE ATTENDANCE SYSTEM</h1>
<p>Face Recognition will automatically mark attendance for registered students.</p>

<!-- CAMERA AREA -->
<div id="cameraBox">
    <video id="video" autoplay muted></video>
    <canvas id="canvas"></canvas>
</div>

<div id="message"></div>

<div class="container">
    <div class="box">
        <div class="present">Present Students</div>
        <ul id="presentList"></ul>
    </div>

    <div class="box">
        <div class="pending">Pending Students</div>
        <ul id="pendingList"></ul>
    </div>
</div>

<p style="margin-top:40px;opacity:0.6;">Developed by <b>Keerthana</b> & <b>Hari Chandhana</b></p>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<script>

// STUDENT LIST
const students = [
    { name: "Keerthana", file: "students/Keerthana.jpeg" },
    { name: "Hari Chandana", file: "students/Hari_Chandana.jpeg" },
    { name: "Vedha Sai G", file: "students/Vedha_Sai_G.jpeg" },
    { name: "Ajith Kumar", file: "students/Ajith_Kumar.jpeg" },
    { name: "Shiva Narayana", file: "students/Shiva_Narayana.jpeg" }
];

let present = [];
let pending = students.map(s => s.name);

function updateLists() {
    document.getElementById("presentList").innerHTML =
        present.map(s => `<li>${s} ✔</li>`).join("");

    document.getElementById("pendingList").innerHTML =
        pending.map(s => `<li>${s} ⏳</li>`).join("");
}

updateLists();

// Show Message
function showMessage(type, text) {
    let box = document.getElementById("message");
    box.className = type;
    box.innerHTML = text;
    box.style.display = "block";
}

// Load Models
Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
]).then(loadStudentFaces);

// Load Student Descriptors
async function loadStudentFaces() {
    const labeledDescriptors = [];

    for (let student of students) {
        const img = await faceapi.fetchImage(student.file);

        const det = await faceapi.detectSingleFace(
            img, new faceapi.TinyFaceDetectorOptions()
        ).withFaceLandmarks().withFaceDescriptor();

        labeledDescriptors.push(
            new faceapi.LabeledFaceDescriptors(student.name, [det.descriptor])
        );
    }

    startCamera(labeledDescriptors);
}

// Start Camera + Recognition
async function startCamera(labeledFaces) {

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");

    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    video.onplay = () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };

        canvas.width = displaySize.width;
        canvas.height = displaySize.height;

        const matcher = new faceapi.FaceMatcher(labeledFaces, 0.43);

        setInterval(async () => {

            const detections = await faceapi.detectAllFaces(
                video,
                new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks().withFaceDescriptors();

            const resized = faceapi.resizeResults(detections, displaySize);

            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            resized.forEach(result => {
                const match = matcher.findBestMatch(result.descriptor).label;
                const box = result.detection.box;

                // Draw green box
                ctx.strokeStyle = "#4ade80";
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                ctx.fillStyle = "#4ade80";
                ctx.fillText(match, box.x, box.y - 5);

                // ATTENDANCE
                if (match !== "unknown" && pending.includes(match)) {
                    present.push(match);
                    pending = pending.filter(name => name !== match);
                    updateLists();
                    showMessage("success", `✔ Attendance taken for <b>${match}</b>`);
                }
            });

        }, 300);
    };
}

</script>

</body>
</html>
